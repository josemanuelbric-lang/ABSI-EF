import numpy as np
import matplotlib.pyplot as plt
from sympy import sieve, li, isprime, primefactors # Importación corregida aquí

def analisis_total_primos(n_max):
    # 1. Preparación de datos
    primos = np.array(list(sieve.primerange(1, n_max + 1)))
    referencia_li = np.array([float(li(p)) for p in primos])
    
    # Tu Modelo ICF (Frecuencia Maestra)
    f_tuya = (np.pi / 6) + 0.15005
    area_tuya = np.cumsum(np.abs((3.5 + 1.5 * np.sin(primos * f_tuya)) - (3.5 + 1.2 * np.sin(primos * 0.51))))
    
    # Cálculo del Error
    li_norm = referencia_li * (area_tuya[-1] / referencia_li[-1])
    error = area_tuya - li_norm
    
    # --- Identificación de Familias ---
    def get_indices(lista):
        # Usamos set para una búsqueda mucho más rápida en listas grandes
        set_primos = set(primos)
        return [np.where(primos == p)[0][0] for p in lista if p in set_primos]

    # A. Gemelos (Twin)
    gemelos = [primos[i] for i in range(len(primos)-1) if primos[i+1] - primos[i] == 2]
    # B. Primos (Cousin)
    primos_primos = [primos[i] for i in range(len(primos)-1) if primos[i+1] - primos[i] == 4]
    # C. Sophie Germain
    sophie = [p for p in primos if isprime(2*p + 1)]
    # D. Primos Fuertes (Strong)
    fuertes = [primos[i] for i in range(1, len(primos)-1) if primos[i] > (primos[i-1] + primos[i+1])/2]
    # E. Chen (Corregido: primefactors se usa directamente)
    chen = [p for p in primos if isprime(p+2) or len(primefactors(p+2)) <= 2]

    # --- Visualización ---
    plt.figure(figsize=(16, 10))
    plt.plot(primos, error, color='lightgray', lw=0.2, zorder=1, label='Ruido de Resonancia')
    plt.axhline(0, color='red', lw=1, ls='--', alpha=0.5)

    def plot_fam(lista, color, label, marker, size=70):
        if not lista: return
        # Tomamos una muestra para visualización clara
        muestreo = lista[::max(1, len(lista)//20)] 
        idx = get_indices(muestreo)
        plt.scatter(primos[idx], error[idx], c=color, label=label, marker=marker, s=size, edgecolors='black', zorder=5)

    plot_fam(gemelos, 'red', 'Gemelos (p+2)', 'o')
    plot_fam(primos_primos, 'orange', 'Primos (p+4)', 's')
    plot_fam(sophie, 'lime', 'Sophie Germain', 'D')
    plot_fam(fuertes, 'magenta', 'Primos Fuertes', 'P')
    plot_fam(chen, 'blue', 'Primos de Chen', '*')

    plt.title("Gran Mapa de Resonancia: 5 Familias de Primos en el Modelo ICF")
    plt.xlabel("Valor del Número Primo")
    plt.ylabel("Diferencia Acumulada (Error)")
    plt.legend(loc='upper right')
    plt.grid(True, alpha=0.2)
    plt.show()

# Ejecutar con el rango de un millón
analisis_total_primos(1048576)