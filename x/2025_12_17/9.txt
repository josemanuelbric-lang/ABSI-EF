import numpy as np
import matplotlib.pyplot as plt

def calcular_tasa_contraccion(limite_x, pasos_objetivo):
    # Generamos tu serie A' (3k-1)
    serie_a_prima = [n for n in range(1, limite_x + 1) if (n + 1) % 3 == 0]
    
    tasas_por_paso = []
    
    for n_inicial in serie_a_prima:
        temp = n_inicial
        valores_trayectoria = [1.0] # Valor relativo inicial (n/n_inicial)
        
        for _ in range(pasos_objetivo):
            if temp == 1:
                valores_trayectoria.append(valores_trayectoria[-1]) # Se queda en 1
            else:
                temp = temp // 2 if temp % 2 == 0 else 3 * temp + 1
                valores_trayectoria.append(temp / n_inicial)
        
        tasas_por_paso.append(valores_trayectoria)
    
    # Calculamos el promedio de la tasa en cada paso para toda la serie
    promedio_tasas = np.mean(tasas_por_paso, axis=0)
    return promedio_tasas

# --- Ejecución ---
pasos = 1000
limite = 5000
tasas = calcular_tasa_contraccion(limite, pasos)

# --- Visualización ---
plt.figure(figsize=(10, 6))
plt.plot(range(pasos + 1), tasas, color='green', linewidth=2, label='Tasa de Contracción Promedio')
plt.axhline(y=1.0, color='red', linestyle='--', label='Punto de Equilibrio (Sin cambio)')
plt.fill_between(range(pasos + 1), tasas, 1.0, where=(tasas < 1.0), color='green', alpha=0.2, label='Zona de Contracción')

plt.title(f"Tasa de Contracción de la Serie A' (N={limite})")
plt.xlabel("Pasos de Iteración de Collatz")
plt.ylabel("Valor Relativo Promedio (N_actual / N_inicial)")
plt.yscale('log') # Escala logarítmica para ver la caída exponencial
plt.grid(True, which="both", ls="-", alpha=0.2)
plt.legend()
plt.show()

print(f"Tasa final después de {pasos} pasos: {tasas[-1]:.6f}")